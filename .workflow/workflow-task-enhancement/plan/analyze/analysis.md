# 需求分析: workflow-task-enhancement

> **分析日期**: 2026-01-15
> **Spec 版本**: 1.1.0

---

## 1. 功能需求摘要

| ID | 需求 | 来源 | 技术影响 | 验收方式 | 优先级 | 需调研 |
|----|------|------|----------|----------|--------|--------|
| FR-1 | 6 阶段工作流程 (PARSE→DECOMPOSE→ANALYZE→REVIEW→REFINE→VALIDATE) | US-1, US-5, US-6 | SKILL.md 主体结构重构 | 流程完整性测试 | P0 | 否 |
| FR-2 | 任务结构定义 (id, title, description, priority, estimate, depends_on, markers, status, module) | US-1 | tasks.md 模板设计 | 格式验证脚本 | P0 | 否 |
| FR-3 | 资源文件创建 (assets/, references/, scripts/) | spec 1.3 | 目录结构和文件创建 | 文件存在性检查 | P1 | 是 |
| FR-4 | 命令接口 (完整/单阶段/选项) | spec 3.4 | 命令格式文档 | 命令解析测试 | P1 | 否 |
| FR-5 | 任务粒度检测 (30min-8h 范围警告) | US-2 | ANALYZE 阶段逻辑 | 边界值测试 | P1 | 否 |
| FR-6 | 任务依赖分析 (DAG 生成, 关键路径, 并行标记) | US-3 | ANALYZE 阶段逻辑 | DAG 正确性验证 | P0 | 是 |
| FR-7 | TDD 任务标记 ([T] 标记规则) | US-4 | DECOMPOSE 阶段逻辑 | 标记一致性检查 | P1 | 否 |
| FR-8 | 独立 Agent 审查 (Task 工具调用) | US-5 | REVIEW 阶段设计 | 审查报告格式验证 | P0 | 是 |
| FR-9 | 用户验证确认 (预览/调整/批准) | US-6 | VALIDATE 阶段设计 | 交互流程测试 | P1 | 否 |
| FR-10 | 断点恢复 (.state.yaml 管理) | US-7 | 状态管理机制 | 恢复正确性测试 | P1 | 是 |

---

## 2. 非功能需求摘要

| ID | 需求 | 质量属性 | 量化指标 | 来源 | 验收方式 | 优先级 |
|----|------|----------|----------|------|----------|--------|
| NFR-1 | 一致性 | 可维护性 | SKILL.md 章节结构与 workflow-plan 90%+ 一致 | spec 4.1 | 结构对比 | P0 |
| NFR-2 | 可维护性 | 可维护性 | 每阶段独立章节，资源文件分离 | spec 4.2 | 代码审查 | P1 |
| NFR-3 | 兼容性 | 兼容性 | 100% 兼容 workflow-plan v1.0+ 输出 | spec 4.3 | 集成测试 | P0 |
| NFR-4 | 优先级分配 | 可用性 | P0-P3 自动分配规则明确 | spec 4.4 | 规则验证 | P1 |

---

## 3. 技术约束

- **约束 1**: 必须使用 Markdown 格式输出（与现有 workflow-* skills 一致）
- **约束 2**: 必须使用 Mermaid 语法生成流程图和 DAG 图
- **约束 3**: 必须通过 Task 工具调用独立 Agent 进行审查
- **约束 4**: 必须保持与 workflow-plan 输出的 plan.md 格式兼容
- **约束 5**: 必须保持与 workflow-implement 消费的 tasks.md 格式兼容

---

## 4. 范围与非目标

### 范围

- 完整重构 `skills/workflow-task/SKILL.md`（146行→300+行）
- 创建 `assets/tasks-template.md` 任务模板
- 创建 `references/phase-details.md` 阶段详情参考
- 创建 `scripts/validate-tasks.sh` 验证脚本

### 非目标

- 与 task-planner skill 合并
- 支持多种输出格式（仅 Markdown）
- 直接从需求生成任务（需先 specify→plan）
- 任务执行功能（属于 workflow-implement）
- 与外部项目管理工具集成

---

## 5. 待决策点

- [x] **决策点 1**: 6 阶段命名 - 已决定使用 PARSE/DECOMPOSE/ANALYZE/REVIEW/REFINE/VALIDATE
- [ ] **决策点 2**: REVIEW 阶段审查 prompt 结构 - 需参考 workflow-plan（需调研）
- [ ] **决策点 3**: .state.yaml 格式设计 - 需与 workflow-plan 保持一致（需调研）
- [x] **决策点 4**: 任务粒度阈值 - 已决定 30min-8h
- [ ] **决策点 5**: DAG 生成算法 - 需确定依赖推导逻辑（需调研）
- [x] **决策点 6**: 标记类型 - 已决定 [T][P][R] 三种

---

## 6. 调研主题

| 主题 | 原因 | 优先级 | 状态 |
|------|------|--------|------|
| workflow-plan 的审查 prompt 结构 | 需保持一致风格，参考 references/review-checklist.md | P0 | 待调研 |
| workflow-plan 的 .state.yaml 完整格式 | 需保持一致的状态管理机制 | P0 | 待调研 |
| 现有 workflow-task 的 tasks.md 模板 | 评估可复用部分，确定需要增强的内容 | P0 | 待调研 |
| workflow-implement 消费 tasks.md 的方式 | 确保输出兼容性 | P1 | 待调研 |
| DAG 生成和关键路径算法 | 确定 ANALYZE 阶段的依赖分析逻辑 | P1 | 待调研 |

---

## 7. 假设与风险

| ID | 假设/风险 | 影响 | 缓解策略 |
|----|-----------|------|----------|
| AR-01 | 假设: plan.md 格式稳定 | 低 | 在 PARSE 阶段添加格式验证 |
| AR-02 | 风险: 任务粒度估算不准确 | 中 | 允许用户在 VALIDATE 覆盖 |
| AR-03 | 风险: 审查循环过多导致流程卡住 | 中 | 限制最多 3 轮 |
| AR-04 | 假设: 用户熟悉 workflow 流程 | 低 | 提供清晰的命令文档 |
| AR-05 | 风险: 循环依赖检测遗漏 | 高 | 使用标准 DAG 算法检测 |

---

## 8. 现有代码库分析

### 8.1 相关模块

- **workflow-plan**: 参考架构，提供 6 阶段流程模板
- **workflow-specify**: 上游流程，提供 spec.md 格式
- **workflow-implement**: 下游流程，消费 tasks.md
- **task-planner**: 独立 skill，边界参考

### 8.2 可复用组件

- workflow-plan 的流程图 ASCII art 结构
- workflow-plan 的阶段说明格式
- workflow-plan 的资源文件组织方式
- 现有 workflow-task 的 tasks.md 模板（部分）

### 8.3 需要修改的文件

| 文件 | 操作 | 原因 |
|------|------|------|
| `skills/workflow-task/SKILL.md` | 重构 | 主要交付物，从 146 行扩展到完整版本 |
| `skills/workflow-task/assets/tasks-template.md` | 新建 | 标准化任务模板 |
| `skills/workflow-task/references/phase-details.md` | 新建 | 详细阶段说明 |
| `skills/workflow-task/scripts/validate-tasks.sh` | 新建 | 格式验证脚本 |

---

*Generated by workflow-plan (ANALYZE) | 2026-01-15*
