# Round 1 改进记录

> **改进日期**: 2026-01-14

---

## 问题修复

### 1. 修正流程图和回退规则

**问题**: REVIEW-2 回退到 RESEARCH 后，流程不明确

**修复**: 明确定义回退后的完整执行路径：

```
回退规则（修正版）:

REVIEW-2 判定 NEEDS_RESEARCH 时:
  → 回退到 RESEARCH
  → 重新执行 REVIEW-1
  → 通过后进入 PLAN
  → 重新执行 REVIEW-2
  → 通过后进入 VALIDATE

REVIEW-2 判定 NEEDS_PLAN 时:
  → 回退到 PLAN
  → 重新执行 REVIEW-2
  → 通过后进入 VALIDATE

REVIEW-1 判定 NEEDS_RESEARCH 时:
  → 回退到 RESEARCH
  → 重新执行 REVIEW-1

REVIEW-1 判定 NEEDS_ANALYZE 时:
  → 回退到 ANALYZE
  → 重新执行 RESEARCH
  → 重新执行 REVIEW-1
```

### 2. RESEARCH 阶段超时控制

**问题**: 缺少超时配置

**修复**: 添加以下配置：

```yaml
research:
  timeout: 300  # 5 分钟
  web_search_timeout: 30  # 单次搜索 30 秒
  max_sources: 10  # 最多引用 10 个来源
```

### 3. 状态文件恢复机制

**问题**: 缺少恢复机制说明

**修复**: 添加以下说明：

```
状态恢复规则:
1. 如果 .state.yaml 损坏或缺失:
   - 扫描目录结构推断当前阶段
   - 如果存在 plan.md → 至少完成 PLAN
   - 如果存在 research.md → 至少完成 RESEARCH
   - 如果存在 analysis.md → 至少完成 ANALYZE
2. 询问用户是否从推断的阶段继续
3. 重建 .state.yaml
```

---

## 修正后的流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           WORKFLOW-PLAN v2.0                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐                           │
│  │ ANALYZE  │───►│ RESEARCH │───►│ REVIEW-1 │                           │
│  │ 需求分析 │◄───│ 技术调研 │◄───│ 分析审查 │                           │
│  └────▲─────┘    └────▲─────┘    └────┬─────┘                           │
│       │               │               │                                  │
│       │               │         ┌─────┴─────┐                            │
│       │               │         ▼           ▼                            │
│       │               │      [PASS]   [NEEDS_WORK]                       │
│       │               │         │           │                            │
│       │               │         │    ┌──────┴──────┐                     │
│       │               │         │    ▼             ▼                     │
│       │               └─────────┤ [RESEARCH]  [ANALYZE]                  │
│       └─────────────────────────┴──────────────────┘                     │
│                                 │                                        │
│                                 ▼                                        │
│                          ┌──────────┐                                    │
│                          │   PLAN   │◄──────────────┐                    │
│                          │ 架构设计 │               │                    │
│                          └────┬─────┘               │                    │
│                               │                     │                    │
│                               ▼                     │                    │
│                          ┌──────────┐               │                    │
│                          │ REVIEW-2 │               │                    │
│                          │ 设计审查 │               │                    │
│                          └────┬─────┘               │                    │
│                               │                     │                    │
│                         ┌─────┴─────┐               │                    │
│                         ▼           ▼               │                    │
│                      [PASS]   [NEEDS_WORK]          │                    │
│                         │           │               │                    │
│                         │    ┌──────┴──────┐        │                    │
│                         │    ▼             ▼        │                    │
│                         │ [RESEARCH]    [PLAN]──────┘                    │
│                         │    │                                           │
│                         │    └───────► REVIEW-1 ───► PLAN ───► REVIEW-2  │
│                         │                                                │
│                         ▼                                                │
│                    ┌──────────┐                                          │
│                    │ VALIDATE │                                          │
│                    │ 用户批准 │                                          │
│                    └──────────┘                                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

*Improved based on Round 1 review | 2026-01-14*
